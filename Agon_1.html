<!-- 카메라 안 끄고 한 페이지에서 루틴 운동 마치기 성공 코드!!!-->

<!DOCTYPE html>
<html lang="eg">
<head>
    <meta charset="UTF-8">
    <!-- Required meta tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>AGON</title>
    
</head>
<body>
	<div><h1>AGON (SQUAT -- JUMPING JACKS -- LUNGE)</h1></div>
	<button id="autoClickBtn" type="button" onclick="init()"
			style="background-color: #4CAF50; border: none; color: white; padding: 15px 32px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px;">
		Let's Go
	</button>
	<div><canvas id="canvas"></canvas></div>
	<div id="label-container"></div>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
	<script type="text/javascript">



		// 1. prediction[i].className = "Stand_Stance";
		// 2. prediction[i].className = "Squat_Stance";

		window.onload = function(){
			document.getElementById('autoClickBtn').click();
		}

	    const URL = "./models/SQUAT_MODEL/my-pose-model/";
	    let model, webcam, ctx, labelContainer, maxPredictions;

	    async function init() {
			
			// ## CHECK POINT ##
	        // Convenience function to setup a webcam

	        webcam = new tmPose.Webcam(500, 500, true); // width, height, flip
	        await webcam.setup(); // request access to the webcam
	        await webcam.play();
	        window.requestAnimationFrame(loop);


	        const modelURL = URL + "model.json";
	        const metadataURL = URL + "metadata.json";

	        // 5 4 3 2 1 Are you ready? Go!
	    	var audio = new Audio('./data/Voice/English/AreYouReady.mp3')
	        audio.play()

	        // load the model and metadata
	        // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
	        // Note: the pose library adds a tmPose object to your window (window.tmPose)
	        model = await tmPose.load(modelURL, metadataURL);
	        maxPredictions = model.getTotalClasses();

	        const size = 500;
	        const flip = true; // whether to flip the webcam


	        // append/get elements to the DOM
	        const canvas = document.getElementById("canvas");
	        canvas.width = size; canvas.height = size;
	        ctx = canvas.getContext("2d");
	        labelContainer = document.getElementById("label-container");
	        for (let i = 0; i < maxPredictions; i++) { // and class labels
	            labelContainer.appendChild(document.createElement("div"));
	        }
	    }

	    async function loop(timestamp) {
	        webcam.update(); // update the webcam frame
	        await predict();
	        window.requestAnimationFrame(loop);
	    }

	    var status = "stand";
	    
	    var count_1 = 0;
	    var count_2 = 0;
	    var count_3 = 0;
	    var count_4 = 0;
	    var count_5 = 0;



	    async function predict() {
	        // Prediction #1: run input through posenet
	        // estimatePose can take in an image, video or canvas html element
	        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
	        // Prediction 2: run input through teachable machine classification model
	        const prediction = await model.predict(posenetOutput);
	        
	        // 50개 이어야 하는데 우선 테스트로 10개
	        // 각
	        if(count_1==10){
	        	count_1=0;
	        	// count_1에서 목표개수가 채워지면 다음 운동 모델로 변경;
	        	const URL = "./models/JUMPINGJACKS_model/my-pose-model/";
	        	const modelURL = URL + "model.json";
		        const metadataURL = URL + "metadata.json";
		        model = await tmPose.load(modelURL, metadataURL);


	        	// 고생했어요 다음으로 갑니다. mp3 
	        	var audio = new Audio('./data/Voice/한글/유학생/가주아_유학생.mp3')
	        	audio.play()

	        	// Now we start Next Workout Audio play!
	        	// location.replace("Athene_2.html")
	        }

	        if(count_2==10){
	        	count_2++;
	        	// count_2에서 목표개수가 채워지면 다음 운동 모델로 변경;
	        	const URL = "./models/LUNGE_model(new)/my-pose-model/";
	        	const modelURL = URL + "model.json";
		        const metadataURL = URL + "metadata.json";
		        model = await tmPose.load(modelURL, metadataURL);


	        	// 고생했어요 다음으로 갑니다. mp3 
	        	var audio = new Audio('./data/Voice/한글/유학생/가주아_유학생.mp3')
	        	audio.play()
	        }

	        if(count_3==10){
	        	count_3++;
	        	// count_2에서 목표개수가 채워지면 다음 운동 모델로 변경;
	        	const URL = "./models/SQUAT_MODEL/my-pose-model/";
	        	const modelURL = URL + "model.json";
		        const metadataURL = URL + "metadata.json";
		        model = await tmPose.load(modelURL, metadataURL);

		        location.replace("Result.html")
	        	// 고생했어요 다음으로 갑니다. mp3 
	        	var audio = new Audio('./data/Voice/한글/유학생/고생했어요.mp3')
	        	audio.play()

	        	var audio = new Audio('./data/Voice/HoldOn.mp3')
	        	audio.play()


	        }
	        

	        // 111111111111111111111111111
	        // First Workout (SQUAT) Start 
	        // First workout in Athene
       		// 1. prediction[i].className = "Stand_Stance";
			// 2. prediction[i].className = "Squat_Stance";
	        if( (prediction[0].probability.toFixed(2) >= 0.92)  && prediction[0].className == "Stand_Stance") { 
	        	if(status=="do"){
	        		count_1++;
	        		var audio = new Audio('./data/Voice/한글/유학생/' + count_1%10 +'_유학생.mp3')
	        		audio.play()

	        		if((count_1 >= 10) && (count_1%10==0)){
		        		var audio = new Audio('./data/Voice/English/VeryGood_UK.mp3')
		        		audio.play()	
	        		}
	        	}

	        	status = "stand";
	        } else if(  (prediction[1].probability.toFixed(2) >= 0.92) && (prediction[1].className == "Squat_Stance")) {
	        	status = "do";
	        }


	        if(prediction[0].className == "Stand_Stance"){
		        for (let i = 0; i < maxPredictions; i++) {
		            if((i==0)){
			            const classPrediction = "STANCE_STANCE " + ": " + prediction[i].probability.toFixed(2);
			            labelContainer.childNodes[i].innerHTML = classPrediction;	
		            } else if ((i==1)) {
		            	const classPrediction = "SQUAT_STANCE"  + ": " + prediction[i].probability.toFixed(2);
		            	labelContainer.childNodes[i].innerHTML = classPrediction;
		            }
		        }
		    }
		    // First Workout End



		    // 22222222222222222222
		    // Second Workout Start
		    // ["nije jumping jack","jumping jack"]
	        if( (prediction[0].probability.toFixed(2) >= 0.92)  && prediction[0].className == "nije jumping jack") { 
	        	if(status=="do"){
	        		count_2++;
	        		var audio = new Audio('./data/Voice/한글/유학생/' + count_2%10 +'_유학생.mp3')
	        		audio.play()

	        		if((count_2 >= 10) && (count_2%10==0)){
		        		var audio = new Audio('./data/Voice/English/VeryGood_UK.mp3')
		        		audio.play()	
	        		}
	        	}

	        	status = "stand";
	        } else if(  (prediction[1].probability.toFixed(2) >= 0.92) && (prediction[1].className == "jumping jack")) {
	        	status = "do";
	        }


	        if(prediction[0].className == "nije jumping jack"){
		        for (let i = 0; i < maxPredictions; i++) {
		            if((i==0)){
			            const classPrediction = "JUMPING_JACKS_STAND " + ": " + prediction[i].probability.toFixed(2);
			            labelContainer.childNodes[i].innerHTML = classPrediction;	
		            } else if ((i==1)) {
		            	const classPrediction = "JUMPING_JACKS_JUMP "  + ": " + prediction[i].probability.toFixed(2);
		            	labelContainer.childNodes[i].innerHTML = classPrediction;
		            }
		        }
		    }
		    // Second Ends


		    // 333333333333333333333333
		    // Third Workout Start
		    // ["LUNGE_DOWN","LUNGE_UP"]
	        if( (prediction[1].probability.toFixed(2) >= 0.90)  && prediction[1].className == "LUNGE_UP") { 
	        	if(status=="do"){
	        		count_3++;
	        		var audio = new Audio('./data/Voice/한글/유학생/' + count_3%10 +'_유학생.mp3')
	        		audio.play()

	        		if((count_3 >= 10) && (count_3%10==0)){
		        		var audio = new Audio('./data/Voice/English/VeryGood_UK.mp3')
		        		audio.play()	
	        		}
	        	}

	        	status = "stand";
	        } else if(  (prediction[0].probability.toFixed(2) >= 0.90) && (prediction[0].className == "LUNGE_DOWN")) {
	        	status = "do";
	        }


	        if(prediction[0].className == "LUNGE_DOWN"){
		        for (let i = 0; i < maxPredictions; i++) {
		            if((i==0)){
			            const classPrediction = "LUNGE_DOWN " + ": " + prediction[i].probability.toFixed(2);
			            labelContainer.childNodes[i].innerHTML = classPrediction;	
		            } else if ((i==1)) {
		            	const classPrediction = "LUNGE_UP "  + ": " + prediction[i].probability.toFixed(2);
		            	labelContainer.childNodes[i].innerHTML = classPrediction;
		            }
		        }
		    }
		    // Third Ends

	        // finally draw the poses
	        drawPose(pose);
	    }













	    function drawPose(pose) {
	        if (webcam.canvas) {
	            ctx.drawImage(webcam.canvas, 0, 0);
	            // draw the keypoints and skeleton
	            if (pose) {
	                const minPartConfidence = 0.5;
	                tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
	                tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
	            }
	        }

			/* 
			prediction[i].className이 어
		
			// prediction[i].className=="sth" 일 때 특정 count_Squat++; 이런식으로 ..
			그 다음 ..
			if(count_Squat==50) 되면 -> function call 한 다음에 
			function 안에는 "잠시 쉰다" mp3 + 모델 URL 변경 + 
			*/
	    }

</script>


</body>
</html>


